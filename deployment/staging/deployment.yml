apiVersion: apps/v1
kind: Deployment
metadata:
  name: mmpl-tendenci-deployment
spec:
  selector:
    matchLabels:
      app: mmpl-tendenci-web-template
  replicas: 1
  template:
    metadata:
      labels: # labels to select/identify the deployment
        app: mmpl-tendenci-web-template
    spec: # pod spec
      initContainers:
        - name: mmpl-tendenci-config-copy
          image: benjiboi214/mmpl-tendenci:cicd_test
          imagePullPolicy: Always
          command: ["/bin/bash"]
          args: ["/runtime/config.sh"]
          # command: ["echo"]
          # args: ["Intitial Run"]
          volumeMounts:
            - mountPath: "/home/tendenci/install"
              name: mmpl-tendenci-test-project
      containers:
        - name: mmpl-tendenci-web
          image: benjiboi214/mmpl-tendenci:cicd_test # image we pushed
          volumeMounts:
            - mountPath: "/home/tendenci/install"
              name: mmpl-tendenci-test-project
            - mountPath: "/var/log/mysite"
              name: mmpl-tendenci-test-log
            - mountPath: "/home/tendenci/cert"
              name: tendenci-cert
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: DB_USER
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: user
            - name: DB_NAME
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: db-name
            - name: DB_PASS
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: pass
            - name: DB_HOST
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: host
            - name: DB_PORT
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: port
            - name: DB_CONN_MAX_AGE
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: conn-max-age
            - name: DB_CERTIFICATE
              valueFrom: 
                secretKeyRef:
                  name: tendenci-postgres
                  key: certificate
            - name: ADMIN_USER
              valueFrom: 
                secretKeyRef:
                  name: tendenci-admin
                  key: user
            - name: ADMIN_MAIL
              valueFrom: 
                secretKeyRef:
                  name: tendenci-admin
                  key: mail
            - name: ADMIN_PASS
              valueFrom: 
                secretKeyRef:
                  name: tendenci-admin
                  key: pass
            - name: DJANGO_SECRET_KEY
              valueFrom: 
                secretKeyRef:
                  name: tendenci-django
                  key: secret-key
            - name: DJANGO_SITE_SETTINGS_KEY
              valueFrom: 
                secretKeyRef:
                  name: tendenci-django
                  key: site-settings-key
      volumes:
        - name: mmpl-tendenci-test-project
          persistentVolumeClaim:
            claimName: mmpl-tendenci-test-project
        - name: mmpl-tendenci-test-log
          persistentVolumeClaim:
            claimName: mmpl-tendenci-test-log
        - name: tendenci-cert
          secret:
            secretName: tendenci-cert
